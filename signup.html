<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>BloodConnect - Sign Up</title>
    <link rel="stylesheet" href="bloodconnect.css"/>
</head>
<body>
    <div class="signup-container">
        <h1 class="signup-header"><i class="fas fa-user-plus"></i> Sign Up for BloodConnect</h1>
        <form id="signupForm" class="signup-form" autocomplete="off">
            <div class="input-group">
                <label for="signupName">Full Name</label>
                <input type="text" id="signupName" placeholder="Enter your full name" required />
                <div class="error-message" id="nameError"></div>
            </div>
            <div class="input-group">
                <label for="signupEmail">Email</label>
                <input type="email" id="signupEmail" placeholder="Enter your Gmail address" required />
                <div class="error-message" id="emailError"></div>
            </div>
            <div class="input-group">
                <label for="signupPassword">Password</label>
                <input type="password" id="signupPassword" placeholder="Create a password" required minlength="8" />
                <div class="error-message" id="passwordError"></div>
            </div>
            <div class="input-group">
                <label for="signupMobile">Mobile Number</label>
                <input type="tel" id="signupMobile" placeholder="Enter your mobile number" required pattern="[0-9]{10}" />
                <div class="error-message" id="mobileError"></div>
            </div>
            <div class="input-group">
                <label for="signupCity">City</label>
                <input type="text" id="signupCity" placeholder="Enter your city" required />
                <div class="error-message" id="cityError"></div>
            </div>
            <div class="input-group">
                <label for="signupAge">Age</label>
                <input type="number" id="signupAge" placeholder="Enter your age" min="18" max="100" required />
                <div class="error-message" id="ageError"></div>
            </div>
            <div class="input-group">
                <label for="signupBloodGroup">Blood Group</label>
                <select id="signupBloodGroup" required>
                    <option value="">Select Blood Group</option>
                    <option value="A+">A+</option>
                    <option value="A-">A-</option>
                    <option value="B+">B+</option>
                    <option value="B-">B-</option>
                    <option value="AB+">AB+</option>
                    <option value="AB-">AB-</option>
                    <option value="O+">O+</option>
                    <option value="O-">O-</option>
                </select>
                <div class="error-message" id="bloodGroupError"></div>
            </div>
            <div class="input-group">
                <label for="signupRole">Role</label>
                <select id="signupRole" required>
                    <option value="">Select Role</option>
                    <option value="donor">Donor</option>
                    <option value="receiver">Receiver</option>
                </select>
                <div class="error-message" id="roleError"></div>
            </div>
            <div id="signupError" class="signup-error-message"></div>
            <button type="submit" class="signup-btn" id="signupBtn">Sign Up</button>
            <div id="signupMsg" class="signup-msg"></div>
            <div class="signup-link nav-links-row">
                <span>Already have an account?</span>
                <a href="newlogin.html" class="nav-link primary">Login</a>
            </div>
            <a href="index.html" class="back-home"><i class="fas fa-arrow-left"></i> Back to Home</a>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>
    <script type="module">
        import { supabase } from './supabaseClient.js';
        document.addEventListener('DOMContentLoaded', function() {
            const signupForm = document.getElementById('signupForm');
            const msg = document.getElementById('signupMsg');
            const signupBtn = document.getElementById('signupBtn');

            // Clear error messages
            function clearErrors() {
                const errorElements = document.querySelectorAll('.error-message');
                const inputElements = document.querySelectorAll('input, select');
                
                errorElements.forEach(el => el.textContent = '');
                inputElements.forEach(el => el.classList.remove('error'));
            }

            // Show field error
            function showFieldError(fieldId, message) {
                const field = document.getElementById(fieldId);
                const errorEl = document.getElementById(fieldId.replace('signup', '').toLowerCase() + 'Error');
                
                if (field) field.classList.add('error');
                if (errorEl) errorEl.textContent = message;
            }

            // Validate mobile number
            function validateMobile(mobile) {
                const mobileRegex = /^[0-9]{10}$/;
                return mobileRegex.test(mobile);
            }

            // Validate email
            function validateEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }

            signupForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                clearErrors();
                msg.textContent = "";
                signupBtn.disabled = true;
                signupBtn.textContent = "Signing Up...";

                const name = document.getElementById('signupName').value.trim();
                const email = document.getElementById('signupEmail').value.trim();
                const password = document.getElementById('signupPassword').value;
                const mobile = document.getElementById('signupMobile').value.trim();
                const city = document.getElementById('signupCity').value.trim();
                const age = document.getElementById('signupAge').value;
                const bloodGroup = document.getElementById('signupBloodGroup').value;
                const role = document.getElementById('signupRole').value;

                let hasErrors = false;

                // Enhanced validation
                if (!name || name.length < 2) {
                    showFieldError('signupName', 'Name must be at least 2 characters');
                    hasErrors = true;
                }

                if (!email || !validateEmail(email)) {
                    showFieldError('signupEmail', 'Please enter a valid email address');
                    hasErrors = true;
                }

                if (!password || password.length < 8) {
                    showFieldError('signupPassword', 'Password must be at least 8 characters');
                    hasErrors = true;
                }

                if (!mobile || !validateMobile(mobile)) {
                    showFieldError('signupMobile', 'Please enter a valid 10-digit mobile number');
                    hasErrors = true;
                }

                if (!city) {
                    showFieldError('signupCity', 'City is required');
                    hasErrors = true;
                }

                if (!age || age < 18 || age > 100) {
                    showFieldError('signupAge', 'Age must be between 18 and 100');
                    hasErrors = true;
                }

                if (!bloodGroup) {
                    showFieldError('signupBloodGroup', 'Please select your blood group');
                    hasErrors = true;
                }

                if (!role) {
                    showFieldError('signupRole', 'Please select your role');
                    hasErrors = true;
                }

                if (hasErrors) {
                    msg.textContent = "❌ Please fix the errors above.";
                    msg.style.color = "var(--error)";
                    signupBtn.disabled = false;
                    signupBtn.textContent = "Sign Up";
                    return;
                }

                msg.textContent = "⏳ Creating your account...";
                msg.style.color = "var(--primary)";

                try {
                    // 1. Sign up with Supabase Auth
                    const { data, error } = await supabase.auth.signUp({
                        email,
                        password,
                        options: {
                            data: {
                                name,
                                role
                            }
                        }
                    });
                    if (data.user?.id) {
    const { error: profileError } = await supabase
        .from('profiles')
        .insert([{
            id: data.user.id,
            name,
            email,
            mobile,
            city,
            age: parseInt(age),
            blood_group: bloodGroup,
            role,
            created_at: new Date().toISOString()
        }]);

    if (profileError) {
        msg.textContent = "❌ " + profileError.message;
        msg.style.color = "var(--error)";
        signupBtn.disabled = false;
        signupBtn.textContent = "Sign Up";
        return;
    }

    // ✅ Add this redirect
    window.location.href = "newlogin.html?signup=success";
    return;
}


                    if (error) {
                        msg.textContent = "❌ " + error.message;
                        msg.style.color = "var(--error)";
                        signupBtn.disabled = false;
                        signupBtn.textContent = "Sign Up";
                        return;
                    }

                    // 2. Insert profile (with better error handling)
                    if (data.user?.id) {
                        const { error: profileError } = await supabase
                            .from('profiles')
                            .insert([{
                                id: data.user.id,
                                name,
                                email,
                                mobile,
                                city,
                                age: parseInt(age),
                                blood_group: bloodGroup,
                                role,
                                created_at: new Date().toISOString()
                            }]);

                        if (profileError) {
                            // If profile creation fails, we should clean up the auth user
                            console.error('Profile creation failed:', profileError);
                            msg.textContent = "❌ Account setup failed. Please try again or contact support.";
                            msg.style.color = "var(--error)";
                            signupBtn.disabled = false;
                            signupBtn.textContent = "Sign Up";
                            return;
                        }
                    }

                    // 3. Success message and redirect
                    msg.textContent = "✅ Account created successfully! Redirecting to login...";
                    msg.style.color = "var(--success)";
                    signupForm.reset();
                    // Redirect after showing success message
                    setTimeout(() => {
                        window.location.href = "newlogin.html?signup=success";
                    }, 1500);

                } catch (err) {
                    console.error('Signup error:', err);
                    msg.textContent = "❌ Something went wrong. Please try again.";
                    msg.style.color = "var(--error)";
                    signupBtn.disabled = false;
                    signupBtn.textContent = "Sign Up";
                }
            });
        });
    </script>
</body>
</html>